<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kings and Peasants</title>
  <meta name="description" content="Rise to the top, or die trying.">
  <meta name="author" content="Manason">
  <script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
	<div class="state">
		<div class="gamestate">
			<p>Lobby</p>
		</div>
		<div class="timer">
			<p>Waiting...</p>
		</div>
	</div>
	
	<div class="player-module">
		<p class="pm-icon">👻</p>
		<p class="pm-name">Spectator</p>
		<p class="pm-prestige">Prestige: 0</p>
		<p class="pm-info">This should have been updated</p>
	</div>
	
	<div class="kings-module">
		<table>
			<tr>
				<td class="km-header">Lookup</td>
				<td class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Lord'});">💎</td>
				<td class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Duke'});">🏰</td>
				<td class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Earl'});">📜</td>
				<td class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Knight'});">🛡️</td>
				<td class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Peasant'});">⚒️</td>
			</tr>
			<tr>
				<td class="km-header">Tax</td>
				<td class="pl-button km-tax km-lord" onclick="socket.emit('messageFromClient', {content: '/tax Lord'});">💎</td>
				<td class="pl-button km-tax km-duke" onclick="socket.emit('messageFromClient', {content: '/tax Duke'});">🏰</td>
				<td class="pl-button km-tax km-earl" onclick="socket.emit('messageFromClient', {content: '/tax Earl'});">📜</td>
				<td class="pl-button km-tax km-knight" onclick="socket.emit('messageFromClient', {content: '/tax Knight'});">🛡️</td>
				<td class="pl-button km-tax km-peasant" onclick="socket.emit('messageFromClient', {content: '/tax Peasant'});">⚒️</td>
			</tr>
		</table>
	</div>
	<div class="playerlist">
		<table>
			<tr>
				<td class="">🥈</td>
				<td class="king name">King Manason</td>
				<td class="disabled emoji">🗡️</td>
				<td class="emoji selected">👼🏻</td>
				<td class="emoji">💀</td>
				<td class="emoji">💸</td>
				<td class="emoji">✨</td>
			</tr>
			<tr>
				<td class="">⭐</td>
				<td class="lord name">Lord Jake</td>
				<td class="emoji selected">🗡️</td>
				<td class="emoji">👼🏻</td>
				<td class="emoji">💀</td>
				<td class="emoji">💸</td>
				<td class="emoji">✨</td>
			</tr>
			<!-- <tr>
				<td class="">🥇</td>
				<td class="duke name">Duke Pheo</td>
				<td class="emoji">🗡️</td>
				<td class="emoji">👼🏻</td>
				<td class="emoji">💀</td>
				<td class="emoji selected">💸</td>
				<td class="emoji">✨</td>
			</tr>
			<tr>
				<td class="">🥈</td>
				<td class="duke name">Duke Teddy</td>
				<td class="emoji">🗡️</td>
				<td class="emoji">👼🏻</td>
				<td class="emoji">💀</td>
				<td class="emoji">💸</td>
				<td class="emoji selected">✨</td>
			</tr>
			<tr>
				<td class="">🥈</td>
				<td class="duke name">Duke Keto</td>
				<td class="emoji">🗡️</td>
				<td class="emoji">👼🏻</td>
				<td class="emoji">💀</td>
				<td class="emoji">💸</td>
				<td class="emoji">✨</td>
			</tr> -->
		</table>
		<!-- Example of a player during voting stage-->
		<!-- <div class="player">
			<input type="radio" name="successor">
			<p>Role Name</p>
			<p class="vote-value">0</p>
			<input type="button" value="Vote" class="vote-button">
		</div> -->
		<!--Example of a player during normal play-->
		<!-- <div class="player">
			<input type="radio" name="successor">
			<p>Role Name</p>
			<input type="radio" name="assassinate" class="playerlisticon">
			<input type="radio" name="protect" class="playerlisticon">
			<input type="radio" name="execute" class="playerlisticon">
			<input type="button" value="give" class="playerlisticon">
			<input type="radio" name="roleaction" class="playerlisticon">
		</div> -->
	</div>

	<div class="chat">
		<div class="chat-window">
			<!-- <div class="chat-entry">
				<div class="chat-time">
					<p>10:50</p>
				</div>
				<div class="chat-name">
					<p>Manason</p>
				</div>
				<div class="chat-message">
					<p>This is an example message</p>
				</div>
			</div> -->
		</div>

		<div class="chat-input">
				<input class="chat-input-box" type="text"></input>
				<input class="chat-input-button" type="submit" value="Send" onclick="enterInput();"></input>
		</div>
	</div>
</body>

<script>
	var input = document.getElementsByClassName("chat-input-box")[0];
	var gamestate = document.getElementsByClassName("gamestate")[0];
	var timer = document.getElementsByClassName("timer")[0];
	var socket = io.connect('http://localhost:8080');
	
	input.onkeypress = function(e){
		if(e.keyCode == '13'){
			enterInput();
		}
	}

	//send message to server for processing
	function enterInput(){
		socket.emit('messageFromClient', {content: input.value});
		input.value = ""; //clear the input
	}

	//receive messages from server
	socket.on('message', function(msg){
		var timestamp = new Date().toTimeString().substring(0, 8);
		$(".chat-window").append(
		'<div class="chat-entry">' +
			'<div class="chat-time">'+
				'<p>'+timestamp+'</p>'+
			'</div>'+
			'<div class="chat-name">'+
				'<p>'+msg.player+'</p>'+
			'</div>'+
			'<div class="chat-message">'+
				'<p>'+msg.message+'</p>'+
			'</div>'+
		'</div>');
	});
	//TODO make these different from a normal message
	socket.on('whisper', function(msg){
		var timestamp = new Date().toTimeString().substring(0, 8);
		$(".chat-window").append(
		'<div class="chat-entry">' +
			'<div class="chat-time">'+
				'<p>'+timestamp+'</p>'+
			'</div>'+
			'<div class="chat-name">'+
				'<p>'+msg.player+'</p>'+
			'</div>'+
			'<div class="chat-message">'+
				'<p>whispered '+msg.message+'</p>'+
			'</div>'+
		'</div>');
	});
	socket.on('yell', function(msg){
		var timestamp = new Date().toTimeString().substring(0, 8);
		$(".chat-window").append(
		'<div class="chat-entry">' +
			'<div class="chat-time">'+
				'<p>'+timestamp+'</p>'+
			'</div>'+
			'<div class="chat-name">'+
				'<p>'+msg.player+'</p>'+
			'</div>'+
			'<div class="chat-message">'+
				'<p>YELLED '+msg.message+'</p>'+
			'</div>'+
		'</div>');
	});
	socket.on('gamestate', function(gmst){
		gamestate.innerHTML = gmst.state;
	});
	socket.on('timer', function(time){
		if(isNaN(time.cur_time))
			timer.innerHTML = time.cur_time;
		else{
			var date = new Date(null);
			date.setSeconds(time.cur_time);
			timer.innerHTML = date.toISOString().substr(11, 8);
		}
	});
	socket.on('updateRole', function(player){
		$(".pm-name").html(player.role + " " + player.name);
		switch(player.role){
			case "King":
				$(".pm-icon").html("👑");
				$(".pm-name").css("color: var(--king);");
				$(".pm-info").html("You are the ruler of the kingdom and wield great power. But remember, no one rules alone. Keep the right people happy or your reign may not last long! <br><br>Special Abilities:<br><ul><li>Lookup the combined prestige of any rank</li> <li>Choose a rank to tax. Tax will be collected during the night. (a random rank will be chosen if no rank has been selected).</li></ul>");
				break;
			case "Lord":
				$(".pm-icon").html("💎");
				$(".pm-name").css("color: var(--lord);");
				$(".pm-info").html("Your word is second only to the King. Use your knowledge and abilities to secure your position and amass great wealth. Can appoint a Duke as your successor. <br><br>Special Abilities:<br><ul><li>Lookup any players prestige for a small cost</li></ul>");
				break;
			case "Duke":
				$(".pm-icon").html("🏰");
				$(".pm-name").css("color: var(--duke);");
				$(".pm-info").html("You are the backbone of the nobility, with the unique ability to vote for the next king. Be careful of making enemies, lest the common folk decide you are no longer fit for your position. Can appoint an Earl or a Knight as your successor.<br><br>Special Abilities:<br><ul><li>Block one other player once per day, preventing them from using their own special ability. Does not work on Lords or the King. If used on a fellow Duke, only takes effect at the beginning of the following day.</li></ul>");
				break;
			case "Earl":
				$(".pm-icon").html("📜");
				$(".pm-name").css("color: var(--earl);");
				$(".pm-info").html("Well respected as a leader of the common folk and few in number, you are especially vulnerable to Dukes who view you as a threat or Knights itching to take your place. You will often be the first to recognize alliances and plots. Use this to your advantage.<br><br>Special Abilities:<br><ul><li>Notified in real time when one player gives another player prestige. Player names will be redacted.</li></ul>");
				break;
			case "Knight":
				$(".pm-icon").html("🛡️");
				$(".pm-name").css("color: var(--knight);");
				$(".pm-info").html("You have the most powerful ability, and many influential nobility will want to use you. Choose your allies wisely, you will most likely make enemies as well.<br><br>Special Abilities:<br><ul><li>Watch one other player once per day, telling you who they visit, who visits them, and why. Does not work on the King.</li></ul>");
				break;
			case "Peasant":
				$(".pm-icon").html("⚒️");
				$(".pm-name").css("color: var(--peasant);");
				$(".pm-info").html("Weak and poor, you cannot do much alone, but working together with other commoners, you have the power to topple even the King!<br><br>Special Abilities:<br><ul><li>All abilities that would normally cost prestige, are free.</li></ul>");
				break;
			case "Spectator":
				$(".pm-icon").html("👻");
				$(".pm-name").css("color: darkred;");
				$(".pm-info").html("Spectator is the role you have before being assigned a role. Do not worry, you are still in the game, and will receive a role shortly.");
				break;

		}
	});
	socket.on('updatePrestige', function(prestige){
		$(".pm-prestige").html("Prestige: " + prestige.amount);
	});
	socket.on('playerlist', function(playerList){
		//update playerList here
		var table = document.getElementsByClassName("playerlist")[0].firstChild;
		$(".playerlist table").empty();
		for(var i = 1; i < playerList.length; i++){
			var playerInfo = playerList[0];
			var tableEntry = '<tr>';
			//Set icon for successor
			if(playerInfo.p_name == playerList[i].name)
				tableEntry += '<td class="pl-succ">⭐</td>';
			else if(playerInfo.p_successor == playerList[i].name){
				tableEntry += '<td class="pl-succ">🥇</td>';
			}
			else if((playerInfo.p_role=="Lord" && playerList[i].role=="Duke") || (playerInfo.p_role=="Duke" && (playerList[i].role=="Earl" || playerList[i].role=="Knight"))){
				tableEntry += '<td class="pl-succ" onclick="socket.emit(\'messageFromClient\', {content: \'/sc '+playerList[i].name+'\'});">🥈</td>';
			}
			else{
				tableEntry += '<td class="pl-succ disabled-icon">🥈</td>';
			}
			//Set role and name
			tableEntry += '<td class="pl-name pl-'+playerList[i].role.toLowerCase()+'">' + playerList[i].role + ' ' + playerList[i].name+'</td>';
			if(playerInfo.p_name != playerList[i].name && playerInfo.p_role != "Spectator" && playerList[i].role != "Spectator"){
				//Set button for role action
				if(playerInfo.p_role=="Lord"){
					tableEntry += '<td class="pl-button pl-role" onclick="socket.emit(\'messageFromClient\', {content: \'/lookup '+playerList[i].name+'\'});">✨</td>';
				}
				else if(playerInfo.p_role=="Duke"){
					tableEntry += '<td class="pl-button pl-role" onclick="socket.emit(\'messageFromClient\', {content: \'/block '+playerList[i].name+'\'});">✨</td>';
				}
				else if(playerInfo.p_role=="Knight"){
					tableEntry += '<td class="pl-button pl-role" onclick="socket.emit(\'messageFromClient\', {content: \'/watch '+playerList[i].name+'\'});">✨</td>';
				}
				//Set execute or assassinate buttons
				if((playerInfo.p_role=="King" && playerList[i].role=="Lord") || (playerInfo.p_role=="Lord" && playerList[i].role=="Duke") || (playerInfo.p_role=="Duke" && playerList[i].role=="Earl")) {
					tableEntry += '<td class="pl-button pl-execute" onclick="socket.emit(\'messageFromClient\', {content: \'/e '+playerList[i].name+'\'});">💀</td>';
				}
				else if(playerInfo.p_role=="Earl" || playerInfo.p_role=="Knight" || playerInfo.p_role=="Peasant")
					tableEntry += '<td class="pl-button pl-assassinate" onclick="socket.emit(\'messageFromClient\', {content: \'/a '+playerList[i].name+'\'});">🗡️</td>';
				else
					tableEntry += '<td></td>';
				//Set protect and give buttons
				tableEntry += '<td class="pl-button pl-protect" onclick="socket.emit(\'messageFromClient\', {content: \'/p '+playerList[i].name+'\'});">👼🏻</td>';
				tableEntry += '<td class="pl-button pl-give" onclick="socket.emit(\'messageFromClient\', {content: \'/g '+playerList[i].name+' 2\'});">💸</td>';
			}
			tableEntry += '</tr>';
			$(".playerlist table").append(tableEntry);
			if(playerInfo.p_blocked){
				$(".pl-role").addClass("disabled-icon");
				$(".pl-execute").addClass("disabled-icon");
			}

		}
	});
	socket.on('block', function(){
		$(".pl-role").addClass("disabled-icon");
		$(".pl-execute").addClass("disabled-icon");
	});
	socket.on('setIcons', function(obj){
		if(obj.type == "km-tax"){
			$("."+obj.type).removeClass("selected-icon");
			if(obj.name != "null")
				$(".km-"+obj.name.toLowerCase()).addClass("selected-icon");				
		}
		else{
			$(".pl-"+obj.type).removeClass("selected-icon");
			$(".pl-"+obj.type).removeClass("disabled-icon");
			if(obj.name != "null"){
				$(".playerlist td.pl-name").filter(function () {
					return $(this).text().endsWith(" "+obj.name);
				}).siblings(".pl-"+obj.type).addClass("selected-icon");
				
				if(obj.type == "role")
					$(".playerlist td.pl-name").filter(function () {
						return !$(this).text().endsWith(" "+obj.name);
					}).siblings(".pl-"+obj.type).addClass("disabled-icon");
			}
		}
	});

	function randomTesting(){
		//var cmds1 = ["/start","/start idk","/vote","/vote User2","/duke User2","/sc User2","/sc","/tax Spectator","/tax Lords","/tax Duke","/tax earl","/tax King","/lookup User3","/lookup","/lookup Peasant","/lookup King","fuck these command muthafuckin things","/as;dlfkj;ljw4;fowie","/block User3","/block User1","/block","/Watch","/give User3 2"];
		//var cmds2 = ["/ga User3 3","/a","/a User3","/a User2 User1","/assassinate     fuckthis","/protect and serve","/protect User2","/protect asdfjlwk","/protect","/execute","/e User3","/e User3","/e User3","/e User3","/e User3","/prestige","/prestige User2","/list","/playerlist King","/whisper User2 a fucken message thats right bitch", "/whisper","/whisper User1","/yell fucktHIS SHIT"];
		//var commands = cmds1.concat(cmds2);
		var rand = "User"+Math.floor(Math.random()*15 + 1);
		//commands = ["/block " +rand, "/execute " + rand, "/a " + rand, "/protect " + rand, "/watch " + rand, "/list"];
		commands = ["/vote User3", "/a User3", "/e " + rand];
		var randIndex = Math.floor(Math.random()*commands.length);
		var timestamp = new Date().toTimeString().substring(0, 8);
		$(".chat-window").append(
		'<div class="chat-entry">' +
			'<div class="chat-time">'+
				'<p>'+timestamp+'</p>'+
			'</div>'+
			'<div class="chat-name">'+
				'<p>COMMAND</p>'+
			'</div>'+
			'<div class="chat-message">'+
				'<p>'+commands[randIndex]+'</p>'+
			'</div>'+
		'</div>');
		socket.emit('messageFromClient', {content: commands[randIndex]});
	}

	//for testing purposes
	window.onload = function(){
		socket.emit('messageFromClient', {content: "/host hi"});
		socket.emit('messageFromClient', {content: "/join hi"});
		/*setInterval(function(){
			randomTesting();
		},1000);*/
	}

</script>
</html>
