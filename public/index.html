<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kings and Peasants</title>
  <meta name="description" content="Rise to the top, or die trying.">
  <meta name="author" content="Manason">
  <script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
	<div class="left-sidebar">
		<div class="playerlist">
			<table>
			</table>
		</div>
	</div>

	<div class="right-sidebar">
		<div class="state">
			<div class="gamestate">
				<p>Lobby</p>
			</div>
			<div class="timer">
				<p>Waiting...</p>
			</div>
		</div>
		<div class="player-module">
			<p class="pm-icon">👻</p>
			<p class="pm-name">Spectator</p>
			<p class="pm-prestige">Prestige: 0</p>
			<p class="pm-info">
				Contrary to popular belief, Lorem Ipsum is not simply random text. It has roots in a piece of classical Latin literature from 45 BC, making it over 2000 years old. Richard McClintock, a Latin professor at Hampden-Sydney College in Virginia, looked up one of the more obscure Latin words, consectetur, from a Lorem Ipsum passage, and going through the cites of the word in classical literature, discovered the undoubtable source.
			</p>
		</div>
		<div class="kings-module">
			<p class="km-header">Lookup</p>
			<div class="km-buttons km-lookup">
				<p class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Lord'});">💎</p>
				<p class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Duke'});">🏰</p>
				<p class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Earl'});">📜</p>
				<p class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Knight'});">🛡️</p>
				<p class="pl-button" onclick="socket.emit('messageFromClient', {content: '/lookup Peasant'});">⚒️</p>
			</div>
			<p class="km-header">Tax</p>
			<div class="km-buttons">
				<p class="pl-button km-tax km-lord" onclick="socket.emit('messageFromClient', {content: '/tax Lord'});">💎</p>
				<p class="pl-button km-tax km-duke" onclick="socket.emit('messageFromClient', {content: '/tax Duke'});">🏰</p>
				<p class="pl-button km-tax km-earl" onclick="socket.emit('messageFromClient', {content: '/tax Earl'});">📜</p>
				<p class="pl-button km-tax km-knight" onclick="socket.emit('messageFromClient', {content: '/tax Knight'});">🛡️</p>
				<p class="pl-button km-tax km-peasant" onclick="socket.emit('messageFromClient', {content: '/tax Peasant'});">⚒️</p>
			</div>
		</div>
	</div>

	<div class="chat">
		<div class="chat-window">
			<!-- <div class="chat-entry">
				<div class="chat-time">
					<p>10:50</p>
				</div>
				<div class="chat-name">
					<p>Manason</p>
				</div>
				<div class="chat-message">
					<p>This is an example message</p>
				</div>
			</div> -->
		</div>

		<div class="chat-input">
				<input class="chat-input-box" type="text"></input>
				<input class="chat-input-button" type="submit" value="Send" onclick="enterInput();"></input>
		</div>
	</div>
</body>

<script>
	var input = document.getElementsByClassName("chat-input-box")[0];
	var gamestate = document.getElementsByClassName("gamestate")[0];
	var timer = document.getElementsByClassName("timer")[0];
	var socket = io.connect('http://localhost:8080');
	input.onkeypress = function(e){
		if(e.keyCode == '13'){
			enterInput();
		}
	}

	//send message to server for processing
	function enterInput(){
		socket.emit('messageFromClient', {content: input.value});
		input.value = ""; //clear the input
	}

	//receive messages from server
	socket.on('message', function(msg){
		var timestamp = new Date().toTimeString().substring(0, 8);
		$(".chat-window").append(
		'<div class="chat-entry">' +
			'<div class="chat-time">'+
				'<p>'+timestamp+'</p>'+
			'</div>'+
			'<div class="chat-name">'+
				'<p>'+msg.player+'</p>'+
			'</div>'+
			'<div class="chat-message">'+
				'<p>'+msg.message+'</p>'+
			'</div>'+
		'</div>');
	});
	//TODO make these different from a normal message
	socket.on('whisper', function(msg){
		var timestamp = new Date().toTimeString().substring(0, 8);
		$(".chat-window").append(
		'<div class="chat-entry">' +
			'<div class="chat-time">'+
				'<p>'+timestamp+'</p>'+
			'</div>'+
			'<div class="chat-name">'+
				'<p>'+msg.player+'</p>'+
			'</div>'+
			'<div class="chat-message">'+
				'<p>whispered '+msg.message+'</p>'+
			'</div>'+
		'</div>');
	});
	socket.on('yell', function(msg){
		var timestamp = new Date().toTimeString().substring(0, 8);
		$(".chat-window").append(
		'<div class="chat-entry">' +
			'<div class="chat-time">'+
				'<p>'+timestamp+'</p>'+
			'</div>'+
			'<div class="chat-name">'+
				'<p>'+msg.player+'</p>'+
			'</div>'+
			'<div class="chat-message">'+
				'<p>YELLED '+msg.message+'</p>'+
			'</div>'+
		'</div>');
	});
	socket.on('gamestate', function(gmst){
		gamestate.innerHTML = gmst.state;
	});
	socket.on('timer', function(time){
		if(isNaN(time.cur_time))
			timer.innerHTML = time.cur_time;
		else{
			var date = new Date(null);
			date.setSeconds(time.cur_time);
			timer.innerHTML = date.toISOString().substr(11, 8);
		}
	});
	socket.on('updateRole', function(player){
		$(".pm-name").html(player.role + " " + player.name);
		switch(player.role){
			case "King":
				$(".pm-icon").html("👑");
				$(".pm-name").css("color: var(--king);");
				$(".pm-info").html("You are a king");
				break;
			case "Lord":
				$(".pm-icon").html("💎");
				$(".pm-name").css("color: var(--lord);");
				$(".pm-info").html("You are a lord");
				break;
			case "Duke":
				$(".pm-icon").html("🏰");
				$(".pm-name").css("color: var(--duke);");
				$(".pm-info").html("You are a duke");
				break;
			case "Earl":
				$(".pm-icon").html("📜");
				$(".pm-name").css("color: var(--earl);");
				$(".pm-info").html("You are an earl");
				break;
			case "Knight":
				$(".pm-icon").html("🛡️");
				$(".pm-name").css("color: var(--knight);");
				$(".pm-info").html("You are a knight");
				break;
			case "Peasant":
				$(".pm-icon").html("⚒️");
				$(".pm-name").css("color: var(--peasant);");
				$(".pm-info").html("You are a peasant");
				break;
			case "Spectator":
				$(".pm-icon").html("👻");
				$(".pm-name").css("color: darkred;");
				$(".pm-info").html("You are a spectator");
				break;

		}
	});
	socket.on('updatePrestige', function(prestige){
		$(".pm-prestige").html("Prestige: " + prestige.amount);
	});
	socket.on('playerlist', function(playerList){
		//update playerList here
		var table = document.getElementsByClassName("playerlist")[0].firstChild;
		$(".playerlist table").empty();
		for(var i = 1; i < playerList.length; i++){
			var playerInfo = playerList[0];
			var tableEntry = '<tr>';
			//Set icon for successor
			if(playerInfo.p_name == playerList[i].name)
				tableEntry += '<td class="pl-succ">⭐</td>';
			else if(playerInfo.p_successor == playerList[i].name){
				tableEntry += '<td class="pl-succ">🥇</td>';
			}
			else if((playerInfo.p_role=="Lord" && playerList[i].role=="Duke") || (playerInfo.p_role=="Duke" && (playerList[i].role=="Earl" || playerList[i].role=="Knight"))){
				tableEntry += '<td class="pl-succ" onclick="socket.emit(\'messageFromClient\', {content: \'/sc '+playerList[i].name+'\'});">🥈</td>';
			}
			else{
				tableEntry += '<td class="pl-succ disabled-icon">🥈</td>';
			}
			//Set role and name
			tableEntry += '<td class="pl-name pl-'+playerList[i].role.toLowerCase()+'">' + playerList[i].role + ' ' + playerList[i].name+'</td>';
			if(playerInfo.p_name != playerList[i].name && playerInfo.p_role != "Spectator" && playerList[i].role != "Spectator"){
				//Set button for role action
				if(playerInfo.p_role=="Lord"){
					tableEntry += '<td class="pl-button pl-role" onclick="socket.emit(\'messageFromClient\', {content: \'/lookup '+playerList[i].name+'\'});">✨</td>';
				}
				else if(playerInfo.p_role=="Duke"){
					tableEntry += '<td class="pl-button pl-role" onclick="socket.emit(\'messageFromClient\', {content: \'/block '+playerList[i].name+'\'});">✨</td>';
				}
				else if(playerInfo.p_role=="Knight"){
					tableEntry += '<td class="pl-button pl-role" onclick="socket.emit(\'messageFromClient\', {content: \'/watch '+playerList[i].name+'\'});">✨</td>';
				}
				//Set execute or assassinate buttons
				if((playerInfo.p_role=="King" && playerList[i].role=="Lord") || (playerInfo.p_role=="Lord" && playerList[i].role=="Duke") || (playerInfo.p_role=="Duke" && playerList[i].role=="Earl")) {
					tableEntry += '<td class="pl-button pl-execute" onclick="socket.emit(\'messageFromClient\', {content: \'/e '+playerList[i].name+'\'});">💀</td>';
				}
				else if(playerInfo.p_role=="Earl" || playerInfo.p_role=="Knight" || playerInfo.p_role=="Peasant")
					tableEntry += '<td class="pl-button pl-assassinate" onclick="socket.emit(\'messageFromClient\', {content: \'/a '+playerList[i].name+'\'});">🗡️</td>';
				else
					tableEntry += '<td></td>';
				//Set protect and give buttons
				tableEntry += '<td class="pl-button pl-protect" onclick="socket.emit(\'messageFromClient\', {content: \'/p '+playerList[i].name+'\'});">👼🏻</td>';
				tableEntry += '<td class="pl-button pl-give" onclick="socket.emit(\'messageFromClient\', {content: \'/g '+playerList[i].name+' 2\'});">💸</td>';
			}
			tableEntry += '</tr>';
			$(".playerlist table").append(tableEntry);
			if(playerInfo.p_blocked){
				$(".pl-role").addClass("disabled-icon");
				$(".pl-execute").addClass("disabled-icon");
			}

		}
	});
	socket.on('block', function(){
		$(".pl-role").addClass("disabled-icon");
		$(".pl-execute").addClass("disabled-icon");
	});
	socket.on('setIcons', function(obj){
		if(obj.type == "km-tax"){
			$("."+obj.type).removeClass("selected-icon");
			if(obj.name != "null")
				$(".km-"+obj.name.toLowerCase()).addClass("selected-icon");
		}
		else{
			$(".pl-"+obj.type).removeClass("selected-icon");
			$(".pl-"+obj.type).removeClass("disabled-icon");
			if(obj.name != "null"){
				$(".playerlist td.pl-name").filter(function () {
					return $(this).text().endsWith(" "+obj.name);
				}).siblings(".pl-"+obj.type).addClass("selected-icon");

				if(obj.type == "role")
					$(".playerlist td.pl-name").filter(function () {
						return !$(this).text().endsWith(" "+obj.name);
					}).siblings(".pl-"+obj.type).addClass("disabled-icon");
			}
		}
	});

	function randomTesting(){
		//var cmds1 = ["/start","/start idk","/vote","/vote User2","/duke User2","/sc User2","/sc","/tax Spectator","/tax Lords","/tax Duke","/tax earl","/tax King","/lookup User3","/lookup","/lookup Peasant","/lookup King","fuck these command muthafuckin things","/as;dlfkj;ljw4;fowie","/block User3","/block User1","/block","/Watch","/give User3 2"];
		//var cmds2 = ["/ga User3 3","/a","/a User3","/a User2 User1","/assassinate     fuckthis","/protect and serve","/protect User2","/protect asdfjlwk","/protect","/execute","/e User3","/e User3","/e User3","/e User3","/e User3","/prestige","/prestige User2","/list","/playerlist King","/whisper User2 a fucken message thats right bitch", "/whisper","/whisper User1","/yell fucktHIS SHIT"];
		//var commands = cmds1.concat(cmds2);
		var rand = "User"+Math.floor(Math.random()*15 + 1);
		//commands = ["/block " +rand, "/execute " + rand, "/a " + rand, "/protect " + rand, "/watch " + rand, "/list"];
		commands = ["/vote User3", "/a User3", "/e " + rand];
		var randIndex = Math.floor(Math.random()*commands.length);
		var timestamp = new Date().toTimeString().substring(0, 8);
		$(".chat-window").append(
		'<div class="chat-entry">' +
			'<div class="chat-time">'+
				'<p>'+timestamp+'</p>'+
			'</div>'+
			'<div class="chat-name">'+
				'<p>COMMAND</p>'+
			'</div>'+
			'<div class="chat-message">'+
				'<p>'+commands[randIndex]+'</p>'+
			'</div>'+
		'</div>');
		socket.emit('messageFromClient', {content: commands[randIndex]});
	}

	//for testing purposes
	window.onload = function(){
		socket.emit('messageFromClient', {content: "/host hi"});
		socket.emit('messageFromClient', {content: "/join hi"});
		/*setInterval(function(){
			randomTesting();
		},1000);*/
	}

</script>
</html>
